{% extends "base.html" %}

{% block content %}
<div class="setup-container">
    <h2>Update Spreadsheet Links</h2>
    <p class="setup-description">Please provide the Google Sheets links for both tutor and student responses.</p>
    
    <form method="POST" id="linkForm" onsubmit="return validateForm()">
        <div class="form-group">
            <label for="tutor_form_link">Peer Tutor Responses Sheet:</label>
            <input type="url" 
             id="tutor_form_link" 
             name="tutor_form_link" 
             class="form-control" 
             placeholder="Paste Google Sheets link for tutor responses" 
             value="{{ saved_links.get('tutor_link','') }}"
             required>
        </div>
        
        <div class="form-group">
            <label for="student_form_link">Student Responses Sheet:</label>
            <input type="url" 
             id="student_form_link" 
             name="student_form_link" 
             class="form-control" 
             placeholder="Paste Google Sheets link for student responses" 
             value="{{ saved_links.get('student_link','') }}"
             required>
        </div>

        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
            <button type="submit" class="submit-btn">
            <i class="fas fa-sync-alt"></i>
            Update Links
        </button>
            <button type="button" id="use-last-links" class="submit-btn">Use Last Saved Links</button>
        </div>
    </form>

    {% if saved_links %}
        <div style="margin-top:12px;">
            <strong>Last saved links:</strong>
            <div><a href="{{ saved_links.tutor_link }}" target="_blank">Tutor Sheet</a> | <a href="{{ saved_links.student_link }}" target="_blank">Student Sheet</a></div>
        </div>
    {% endif %}
</div>

<script>
function validateForm() {
    const tutorLink = document.getElementById('tutor_form_link').value;
    const studentLink = document.getElementById('student_form_link').value;
    
    if (!tutorLink || !studentLink) {
        alert('Please enter both spreadsheet links');
        return false;
    }

    // stricter validation: either an export CSV link or an edit link with query params
    const validPattern = /docs\.google\.com\/spreadsheets\/(d|u|c)\/[^\s]+/i;
    if (!validPattern.test(tutorLink) || !validPattern.test(studentLink)) {
        alert('Please enter valid Google Sheets links');
        return false;
    }

    return true;
}
</script>
<script>
var LAST_TUTOR_LINK = "{{ saved_links.get('tutor_link','') }}";
var LAST_STUDENT_LINK = "{{ saved_links.get('student_link','') }}";
document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('use-last-links');
    if (!btn) return;
    btn.addEventListener('click', function(){
        if (LAST_TUTOR_LINK || LAST_STUDENT_LINK) {
            document.getElementById('tutor_form_link').value = LAST_TUTOR_LINK;
            document.getElementById('student_form_link').value = LAST_STUDENT_LINK;
        } else {
            alert('No saved links found');
        }
    });
});
</script>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}